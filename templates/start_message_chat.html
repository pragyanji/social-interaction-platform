{% extends "base.html" %}
{% load static %}
{% block title %}Message Chat Â· Chatsphere{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/messages.css' %}" />
{% endblock %}

{% block content %}
<h2 class="page-title">ðŸ’¬ Messages</h2>
{% if request.user.is_authenticated %}
    <div class="messages-container" data-current-user-id="{{ request.user.id }}">
        <!-- Connected Users List -->
        <div class="connections-card">
            <div class="connections-header">
                <h3>Your Connections</h3>
                <span class="connections-count">{{ connected_users|length }}</span>
            </div>
            {% if connected_users %}
                <div class="users-list">
                    {% for user in connected_users %}
                        <div class="user-item {% if selected_user.id == user.id %}active{% endif %}" data-user-id="{{ user.id }}">
                            <div class="user-info">
                                <a href="{% url 'startmessagechat' user.id %}" class="user-info-link">
                                    <div class="user-avatar-container">
                                        {% if user.profile_pic %}
                                            <img src="{{ user.profile_pic.url }}" alt="{{ user.get_username }}" class="user-avatar" />
                                        {% else %}
                                            <img src="{% static 'img/default_profile.png' %}" alt="Profile" class="user-avatar" />
                                        {% endif %}
                                        <div class="user-status-indicator"></div>
                                    </div>
                                    <div class="user-details">
                                        <p class="user-name">{{ user.full_name }}</p>
                                        <p class="user-username">@{{ user.username }}</p>
                                    </div>
                                </a>
                            </div>
                            {% if user.unread_count > 0 and selected_user.id != user.id %}
                                <span class="unread-badge">{{ user.unread_count }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="connections-empty">
                    <div class="empty-icon">ðŸ‘¥</div>
                    <p class="empty-title">No Connections Yet</p>
                    <p class="empty-text">
                        You don't have any connections yet.<br>
                        {% if verification_status == "UNVERIFIED" %}
                        <a href="{% url 'identity_verification' %}" class="empty-action">Get verified</a> to start messaging.
                        {% else %}
                        <a href="{% url 'startvideochat' %}" class="empty-action">Join video chat</a> to make connections.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>

        <!-- Chat Area -->
        <div class="chat-card chat-container">
            {% if selected_user %}
                <div class="chat-header" data-selected-user-id="{{ selected_user.id }}">
                    <div class="chat-header-avatar-container">
                        {% if selected_user.profile_pic %}
                            <img src="{{ selected_user.profile_pic.url }}" alt="{{ selected_user.get_username }}" class="chat-header-avatar" />
                        {% else %}
                            <div class="chat-header-avatar-placeholder">{{ selected_user.username|first|upper }}</div>
                        {% endif %}
                        <div class="header-status-indicator"></div>
                    </div>
                    <div class="chat-header-info">
                        <h3>{{ selected_user.full_name }}</h3>
                        <p class="chat-header-username">@{{ selected_user.username }}</p>
                        <span class="connection-status disconnected">Offline</span>
                    </div>
                </div>
                <div class="chat-messages">
                    <!-- Messages will be loaded here dynamically by messaging.js -->
                </div>
                <div class="message-input-area">
                    <input type="text" class="message-input" placeholder="Type your message...">
                    <button class="send-message-btn">
                        <span>Send</span>
                        <span>â†’</span>
                    </button>
                </div>
            {% else %}
                <div class="no-conversation">
                    <div class="empty-illustration">ðŸ‘‹</div>
                    <h3>Welcome to Messages!</h3>
                    <p>Select a connection from the list to start chatting.</p>
                    {% if connected_users %}
                        <p class="empty-hint">Click on a user from the left panel to begin messaging.</p>
                    {% else %}
                        <p class="empty-hint">
                            You need connections to message. <a href="{% url 'startvideochat' %}">Join video chat</a> first.
                        </p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
{% else %}
    <div class="card">
        <p>You're not signed in.</p>
        <div class="actions">
            <a class="btn btn-primary" href="{% url 'signin' %}">Sign in</a>
            <a class="btn" href="{% url 'signup' %}">Create account</a>
        </div>
    </div>
{% endif %}

<!-- Include messaging script -->
{% if selected_user %}
<script src="{% static 'js/messaging.js' %}"></script>
{% endif %}

<!-- CSRF Token for API requests -->
{% csrf_token %}

{% endblock %}