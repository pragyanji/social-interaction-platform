{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSphere - Video Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/start_video_chat.css' %}">
</head>
<body class="video-chat-body">
    <div class="video-chat-wrapper">
        <!-- Profile Button - Top Right -->
        <a href="/profile/" class="profile-button" title="View Profile">
            <svg class="profile-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
            <span>Profile</span>
        </a>

        <header id="chat-header" class="chat-header">
            <h1 class="header-title">ðŸŽ¥ Video Chat</h1>
            <p class="header-subtitle">Connect with strangers from around the world.</p>
            <div class="online-indicator">
                <div class="status-dot"></div>
                <span class="online-text">
                    <span id="online-count" class="online-count">0</span> users online
                </span>
            </div>
        </header>

        <main id="main-content" class="main-content">
            <!-- Video feeds -->
            <div id="video-container" class="video-container hidden">
                <div class="video-local-wrapper">
                    <video id="localVideo" autoplay muted playsinline class="video-element"></video>
                    <div class="video-label local-label">You</div>
                    <div class="video-controls">
                        <button id="toggleAudio" aria-label="Toggle microphone" class="media-button" title="Toggle microphone">
                            <svg class="button-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 0 0 2-2V5a2 2 0 1 0-4 0v5a2 2 0 0 0 2 2z"/>
                                <path d="M16 9v1a6 6 0 0 1-12 0V9h2v1a4 4 0 0 0 8 0V9h2z"/>
                            </svg>
                        </button>
                        <button id="toggleVideo" aria-label="Toggle camera" class="media-button" title="Toggle camera">
                            <svg class="button-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2h2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="remoteVideoContainer" class="video-remote-wrapper">
                    <video id="remoteVideo" autoplay playsinline class="video-element"></video>
                    <div class="video-label remote-label">Stranger</div>
                    <!-- Peer Stats Tooltip - shows on hover -->
                    <div id="peerStatsTooltip" class="peer-stats-tooltip">
                        <div id="tooltipContent">
                            <p class="tooltip-text">Hover to load...</p>
                        </div>
                    </div>
                    <div id="loading-spinner" class="loading-spinner hidden">
                        <svg class="spinner-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="spinner-bg" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="spinner-fg" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Status and controls -->
            <div class="controls-section">
                <p id="status" class="status-text">Ready to connect.</p>
                <p id="waiting-users" class="waiting-users"></p>
                <div class="button-group">
                    <button id="startButton"
                        class="btn btn-primary"
                        aria-label="Start video chat"
                        title="Start video chat with a random person">
                        Start Chat
                    </button>
                    <button id="homeButton"
                        class="btn btn-secondary"
                        aria-label="Back to home"
                        title="Return to home page">
                        Back to Home
                    </button>
                    <button id="stopButton"
                        class="btn btn-danger hidden"
                        aria-label="Stop video chat"
                        title="End current chat">
                        Stop Chat
                    </button>
                    <button id="nextButton"
                        class="btn btn-success hidden"
                        aria-label="Find next chat partner"
                        title="End current chat and find a new partner">
                        Next Stranger
                    </button>
                    <button id="reportButton"
                        class="btn btn-warning hidden"
                        aria-label="Report user"
                        title="Report this stranger for inappropriate behavior">
                        Report User
                    </button>
                    <button id="rateButton"
                        class="btn btn-info hidden"
                        aria-label="Rate user"
                        title="Rate this stranger">
                        Rate User
                    </button>
                    {% if verification_status == "VERIFIED" %}
                    <button id="connectButton"
                        class="btn btn-primary hidden"
                        aria-label="Connect with stranger"
                        title="Make connection with current stranger">
                        Connect
                    </button>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2024 ChatSphere. All rights reserved.</p>
        </footer>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="modal-title">Report User</h2>
                <button id="closeModal" class="modal-close" aria-label="Close dialog">
                    <svg class="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="reportForm">
                <div class="form-group">
                    <label class="form-label" for="reportReason">
                        Reason for Report
                    </label>
                    <select id="reportReason" name="reason" required class="form-select">
                        <option value="">Select a reason...</option>
                        <option value="inappropriate_behavior">Inappropriate Behavior</option>
                        <option value="harassment">Harassment</option>
                        <option value="vulgar_content">Vulgar/Explicit Content</option>
                        <option value="spam">Spam</option>
                        <option value="threatening">Threatening Behavior</option>
                        <option value="underage">Underage User</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="reportDescription">
                        Additional Details
                    </label>
                    <textarea id="reportDescription" name="description" rows="4" required class="form-textarea"
                        placeholder="Please provide details about why you're reporting this user..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" id="submitReport" class="btn btn-warning">
                        Submit Report
                    </button>
                    <button type="button" id="cancelReport" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>

            <div id="reportSuccess" class="hidden">
                <div class="success-content">
                    <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="success-title">Report Submitted</h3>
                    <p class="success-text">Thank you for helping keep ChatSphere safe. We will review your report shortly.</p>
                    <button id="closeSuccessModal" class="btn btn-primary">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="modal-title">Rate User</h2>
                <button id="closeRatingModal" class="modal-close" aria-label="Close dialog">
                    <svg class="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="ratingForm">
                <div class="form-group">
                    <label class="form-label">
                        Rate this user (Click a star)
                    </label>
                    <div class="star-rating">
                        <button type="button" class="rating-star" data-rating="1" title="Poor">
                            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                        <button type="button" class="rating-star" data-rating="2" title="Average">
                            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                        <button type="button" class="rating-star" data-rating="3" title="Good">
                            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                        <button type="button" class="rating-star" data-rating="4" title="Excellent">
                            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                        <button type="button" class="rating-star" data-rating="5" title="Outstanding">
                            <svg class="star-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="rating-display">Selected: <span id="selectedRating">-</span></p>
                    <input type="hidden" id="ratingValue" name="rating" value="">
                </div>

                <div class="modal-actions">
                    <button type="submit" id="submitRating" class="btn btn-info">
                        Submit Rating
                    </button>
                    <button type="button" id="cancelRating" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>

            <div id="ratingSuccess" class="hidden">
                <div class="success-content">
                    <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="success-title">Rating Submitted</h3>
                    <p class="success-text">Thank you for rating this user!</p>
                    <button id="closeRatingSuccessModal" class="btn btn-info">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div id="connectModal" class="modal hidden">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="modal-title">Connect?</h2>
                <button id="closeConnectModal" class="modal-close" aria-label="Close dialog">
                    <svg class="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="connectForm">
                <p class="modal-text">
                    Would you like to connect with this user? You'll be able to message them later!
                </p>

                <div class="modal-actions">
                    <button id="confirmConnect" class="btn btn-primary">
                        Connect
                    </button>
                    <button id="cancelConnect" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </div>

            <div id="connectSuccess" class="hidden">
                <div class="success-content">
                    <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="success-title">Connected!</h3>
                    <p class="success-text">You can now message this user in your connections.</p>
                    <button id="closeConnectSuccessModal" class="btn btn-primary">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // @ts-ignore - Django template variable
        window.FIREBASE_CONFIG = {{ firebase_config|safe }};
        // Pass Django user ID to JavaScript
        window.DJANGO_USER_ID = "{{ request.user.id }}";
    </script>

    <script type="module" src="{% static 'js/video-chat.js' %}"></script>
</body>
</html>
