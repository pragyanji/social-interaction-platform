{% extends "base.html" %}
{% load static %}
{% block title %}Connections · Chatsphere{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/connections.css' %}" />
{% endblock %}

{% block content %}
<h2 class="page-title">Connections</h2>
{% if request.user.is_authenticated %}
  <div class="card">
    <h3>Your Connections ({{ connections.count }})</h3>
    {% if connections %}
      <div class="users-list">
        {% for user in connections %}
          <div class="user-item">
            <div class="user-info">
              <div class="user-info-content">
                {% if user.profile_pic %}
                  <img src="{{ user.profile_pic.url }}" alt="{{ user.get_username }}" class="user-avatar" />
                {% else %}
                  <img src="{% static 'img/default_profile.png' %}" alt="Profile" class="user-avatar" />
                {% endif %}
                <div class="user-details">
                  <p class="user-name">{{ user.full_name }}</p>
                  <p class="user-username">@{{ user.username }}</p>
                </div>
              </div>
            </div>
            <div class="connection-actions">
              <a href="{% url 'startmessagechat' user.id %}" class="user-chat-btn" >Message</a>
              <button type="button" class="connection-remove-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.full_name }}">Remove</button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="connections-empty">
        You don't have any connections yet.<br><br>
        <a href="{% url 'connections' %}">Start connecting</a> with other users!
      </p>
    {% endif %}
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay hidden">
    <div class="modal-box">
      <p class="modal-text">Are you sure you want to remove <span id="modalUserName"></span>? This action cannot be undone.</p>
      <div class="modal-actions">
        <button type="button" class="modal-btn modal-cancel" onclick="closeModal()">Cancel</button>
        <button type="button" class="modal-btn modal-confirm" onclick="confirmRemove()">Yes, Remove</button>
      </div>
    </div>
  </div>

  <form id="removeForm" method="POST" style="display: none;">
    {% csrf_token %}
  </form>
  
  
  
  <script>
    let pendingUserId = null;

    document.querySelectorAll('.connection-remove-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        pendingUserId = this.getAttribute('data-user-id');
        const userName = this.getAttribute('data-user-name');
        document.getElementById('modalUserName').textContent = userName;
        document.getElementById('confirmationModal').classList.remove('hidden');
      });
    });

    function closeModal() {
      document.getElementById('confirmationModal').classList.add('hidden');
      pendingUserId = null;
    }

    function confirmRemove() {
      if (pendingUserId) {
        const form = document.getElementById('removeForm');
        form.action = `/connections/remove/${pendingUserId}/`;
        form.submit();
      }
    }

    // Close modal when clicking outside
    document.getElementById('confirmationModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
  
  {% else %}
    <div class="card">
      <p>You’re not signed in.</p>
      <div class="actions">
        <a class="btn btn-primary" href="{% url 'signin' %}">Sign in</a>
        <a class="btn" href="{% url 'signup' %}">Create account</a>
      </div>
    </div>
  {% endif %}
  {% endblock %}