{% extends "base.html" %}
{% load static %}
{% block title %}Change Password ¬∑ Chatsphere{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/change_password.css' %}" />
{% endblock %}

{% block content %}

<div class="change-password-container">
  <div class="change-password-header">
    <h2>üîê Change Password</h2>
    <p>Update your password to keep your account secure</p>
  </div>

  <div class="change-password-card">
    <form method="post" style="display: flex; flex-direction: column; gap: 0;">
      {% csrf_token %}

      <!-- Display non-field errors -->
      {% if form.non_field_errors %}
        <div class="non-field-errors" style="margin-bottom: 24px;">
          {% for error in form.non_field_errors %}
            <p style="margin: 0;">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Current Password -->
      <div class="form-group">
        <label for="{{ form.old_password.id_for_label }}" class="form-label">
          Current Password
        </label>
        <input type="password"
               name="{{ form.old_password.name }}"
               id="{{ form.old_password.id_for_label }}"
               class="form-input"
               placeholder="Enter your current password"
               required>
        {% if form.old_password.errors %}
          <p class="form-error">{{ form.old_password.errors|first }}</p>
        {% endif %}
        {% if form.old_password.help_text %}
          <p class="form-help">{{ form.old_password.help_text }}</p>
        {% endif %}
      </div>

      <!-- New Password -->
      <div class="form-group">
        <label for="{{ form.new_password1.id_for_label }}" class="form-label">
          New Password
        </label>
        <input type="password"
               name="{{ form.new_password1.name }}"
               id="{{ form.new_password1.id_for_label }}"
               class="form-input"
               placeholder="Enter your new password"
               required>
        {% if form.new_password1.errors %}
          <p class="form-error">{{ form.new_password1.errors|first }}</p>
        {% endif %}
        {% if form.new_password1.help_text %}
          <div class="form-help" style="margin-top: 8px;">
            <ul style="margin: 0; padding-left: 18px;">
              <li>Your password can't be too similar to your other personal information.</li>
              <li>Your password must contain at least 8 characters.</li>
              <li>Your password can't be a commonly used password.</li>
              <li>Your password can't be entirely numeric.</li>
            </ul>
          </div>
        {% endif %}
      </div>

      <!-- Confirm New Password -->
      <div class="form-group">
        <label for="{{ form.new_password2.id_for_label }}" class="form-label">
          Confirm New Password
        </label>
        <input type="password"
               name="{{ form.new_password2.name }}"
               id="{{ form.new_password2.id_for_label }}"
               class="form-input"
               placeholder="Re-enter your new password"
               required>
        {% if form.new_password2.errors %}
          <p class="form-error">{{ form.new_password2.errors|first }}</p>
        {% endif %}
        {% if form.new_password2.help_text %}
          <p class="form-help">{{ form.new_password2.help_text }}</p>
        {% endif %}
      </div>

      <!-- Password Strength Indicator -->
      <div id="password-strength" class="password-strength hidden">
        <div class="strength-container">
          <div class="strength-bar-container">
            <div id="strength-bar" class="strength-bar" style="width: 0%"></div>
          </div>
          <span id="strength-text" class="strength-text"></span>
        </div>
      </div>

      <!-- Buttons -->
      <div class="form-actions">
        <button type="submit" class="btn-submit">
          üíæ Change Password
        </button>
        <a href="{% url 'edit_profile' %}" class="btn-cancel">
          ‚úï Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  // Password strength indicator
  const newPassword = document.getElementById('{{ form.new_password1.id_for_label }}');
  const strengthIndicator = document.getElementById('password-strength');
  const strengthBar = document.getElementById('strength-bar');
  const strengthText = document.getElementById('strength-text');

  if (newPassword) {
    newPassword.addEventListener('input', function() {
      const password = this.value;

      if (password.length === 0) {
        strengthIndicator.classList.add('hidden');
        return;
      }

      strengthIndicator.classList.remove('hidden');

      // Calculate strength
      let strength = 0;
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;

      // Update UI
      const colors = ['#ef4444', '#f97316', '#eab308', '#3b82f6', '#10b981'];
      const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
      const widths = ['20%', '40%', '60%', '80%', '100%'];

      strengthBar.style.backgroundColor = colors[strength];
      strengthBar.style.width = widths[strength];
      strengthText.textContent = texts[strength];
      strengthText.style.color = colors[strength];
    });
  }
</script>

{% endblock %}
