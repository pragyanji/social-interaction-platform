{% extends "base.html" %}
{% load static %}
{% block title %}Change Password Â· Chatsphere{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto">
    <h2 class="page-title">Change Password</h2>

    <div class="card">
        <p class="text-gray-400 mb-6">
            Please enter your current password and choose a new one. Your new password must be different from your current password.
        </p>

        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Display non-field errors -->
            {% if form.non_field_errors %}
                <div class="form-error" style="padding: 0.75rem; background-color: #fee2e2; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Old Password -->
            <div class="form-group">
                <label for="{{ form.old_password.id_for_label }}" class="form-label">
                    Current Password
                </label>
                <input type="password"
                       name="{{ form.old_password.name }}"
                       id="{{ form.old_password.id_for_label }}"
                       class="form-input"
                       placeholder="Enter your current password"
                       required>
                {% if form.old_password.errors %}
                    <p class="form-error">{{ form.old_password.errors|first }}</p>
                {% endif %}
                {% if form.old_password.help_text %}
                    <p class="form-help">{{ form.old_password.help_text }}</p>
                {% endif %}
            </div>

            <!-- New Password -->
            <div class="form-group">
                <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                    New Password
                </label>
                <input type="password"
                       name="{{ form.new_password1.name }}"
                       id="{{ form.new_password1.id_for_label }}"
                       class="form-input"
                       placeholder="Enter your new password"
                       required>
                {% if form.new_password1.errors %}
                    <p class="form-error">{{ form.new_password1.errors|first }}</p>
                {% endif %}
                {% if form.new_password1.help_text %}
                    <div class="form-help mt-2">
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Your password can't be too similar to your other personal information.</li>
                            <li>Your password must contain at least 8 characters.</li>
                            <li>Your password can't be a commonly used password.</li>
                            <li>Your password can't be entirely numeric.</li>
                        </ul>
                    </div>
                {% endif %}
            </div>

            <!-- Confirm New Password -->
            <div class="form-group">
                <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                    Confirm New Password
                </label>
                <input type="password"
                       name="{{ form.new_password2.name }}"
                       id="{{ form.new_password2.id_for_label }}"
                       class="form-input"
                       placeholder="Re-enter your new password"
                       required>
                {% if form.new_password2.errors %}
                    <p class="form-error">{{ form.new_password2.errors|first }}</p>
                {% endif %}
                {% if form.new_password2.help_text %}
                    <p class="form-help">{{ form.new_password2.help_text }}</p>
                {% endif %}
            </div>

            <!-- Password Strength Indicator -->
            <div id="password-strength" class="hidden">
                <div class="flex items-center gap-2 mb-2">
                    <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="strength-bar" class="h-full transition-all duration-300"></div>
                    </div>
                    <span id="strength-text" class="text-sm font-medium"></span>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4">
                <button type="submit" class="btn btn-primary flex-1">
                    Change Password
                </button>
                <a href="{% url 'edit_profile' %}" class="btn btn-outline flex-1 text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Password strength indicator
    const newPassword = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthIndicator = document.getElementById('password-strength');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');

    if (newPassword) {
        newPassword.addEventListener('input', function() {
            const password = this.value;

            if (password.length === 0) {
                strengthIndicator.classList.add('hidden');
                return;
            }

            strengthIndicator.classList.remove('hidden');

            // Calculate strength
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            // Update UI
            const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];
            const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            const widths = ['20%', '40%', '60%', '80%', '100%'];

            strengthBar.className = 'h-full transition-all duration-300 ' + colors[strength];
            strengthBar.style.width = widths[strength];
            strengthText.textContent = texts[strength];
            strengthText.className = 'text-sm font-medium ' + colors[strength].replace('bg-', 'text-');
        });
    }
</script>
{% endblock %}
