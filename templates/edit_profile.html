{% extends "base.html" %}
{% load static %}
{% block title %}Edit Profile · Chatsphere{% endblock %}

{% block body_class %} class="doodle-background"{% endblock %}

{% block content %}
<div style="max-width: 42rem; margin: 0 auto;">
    <h2 class="page-title">Edit Profile</h2>

    <div class="card">
        <!-- Current Profile Picture Preview -->
        <div style="text-align: center; margin-bottom: 1.5rem;">
            {% if user.profile_pic %}
                <img src="{{ user.profile_pic.url }}"
                     alt="{{ user.username }}"
                     style="width: 8rem; height: 8rem; border-radius: 9999px; margin: 0 auto; object-fit: cover; border: 4px solid #667eea;"
                     id="current-profile-pic">
            {% else %}
                <div style="width: 8rem; height: 8rem; border-radius: 9999px; margin: 0 auto; background-color: #667eea; display: flex; align-items: center; justify-content: center; border: 4px solid #667eea;">
                    <span style="font-size: 2.25rem; color: white;">{{ user.username|first|upper }}</span>
                </div>
            {% endif %}
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af;">Current Profile Picture</p>
        </div>

        <form method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% csrf_token %}

            <!-- Display non-field errors -->
            {% if form.non_field_errors %}
                <div class="form-error" style="padding: 0.75rem; background-color: #fee2e2; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Full Name -->
            <div class="form-group">
                <label for="{{ form.full_name.id_for_label }}" class="form-label">
                    Full Name
                </label>
                {{ form.full_name }}
                {% if form.full_name.errors %}
                    <p class="form-error">{{ form.full_name.errors|first }}</p>
                {% endif %}
            </div>

            <!-- Email -->
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}" class="form-label">
                    Email Address
                </label>
                {{ form.email }}
                {% if form.email.errors %}
                    <p class="form-error">{{ form.email.errors|first }}</p>
                {% endif %}
                <p class="form-help">We'll never share your email with anyone else.</p>
            </div>

            <!-- Profile Picture -->
            <div class="form-group">
                <label for="{{ form.profile_pic.id_for_label }}" class="form-label">
                    Profile Picture
                </label>
                {{ form.profile_pic }}
                {% if form.profile_pic.errors %}
                    <p class="form-error">{{ form.profile_pic.errors|first }}</p>
                {% endif %}
                <p class="form-help">Choose a new profile picture (JPG, PNG, or GIF, max 5MB)</p>

                <!-- Image Preview -->
                <div id="image-preview" style="margin-top: 1rem; display: fit;">
                    <p style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">New Image Preview:</p>
                    <img id="preview-image" style="width: 8rem; height: 8rem; border-radius: 9999px; object-fit: cover; border: 2px solid #4b5563;" alt="Preview">
                </div>
            </div>

            <!-- Username (Read-only) -->
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text"
                       value="{{ user.username }}"
                       disabled
                       style="opacity: 0.5; cursor: not-allowed;"
                       class="form-input">
                <p class="form-help">Username cannot be changed.</p>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    Save Changes
                </button>
                <a href="{% url 'profile' %}" class="btn btn-outline" style="flex: 1; text-align: center; display: flex; align-items: center; justify-content: center;">
                    Cancel
                </a>
            </div>

            <!-- Change Password Link -->
            <div style="text-align: center; padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-top: 0.5rem;">
                <a href="{% url 'change_password' %}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                    Change Password →
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Image preview functionality
    const fileInput = document.getElementById('{{ form.profile_pic.id_for_label }}');
    const previewContainer = document.getElementById('image-preview');
    const previewImage = document.getElementById('preview-image');

    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];

            if (file) {
                // Check file type
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image must be less than 5MB');
                    return;
                }

                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %}
