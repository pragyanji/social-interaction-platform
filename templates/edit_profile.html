{% extends "base.html" %}
{% load static %}
{% block title %}Edit Profile ¬∑ Chatsphere{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/edit_profile.css' %}" />
{% endblock %}

{% block content %}

<div class="edit-profile-container">
  <div class="edit-profile-header">
    <h2>Edit Your Profile</h2>
    <p>Update your information and profile picture</p>
  </div>

  <div class="edit-profile-card">
    <!-- Current Profile Picture Preview -->
    <div class="profile-pic-preview">
      <div class="profile-pic-container">
        {% if user.profile_pic %}
          <img src="{{ user.profile_pic.url }}"
               alt="{{ user.username }}"
               id="current-profile-pic">
        {% else %}
        
          <div class="profile-pic-placeholder">
            <img src="{% static 'img/default_profile.png' %}"
                 alt="Default Profile"
                 id="current-profile-pic">
          </div>
        {% endif %}
      </div>
      <p class="profile-pic-label">Current Profile Picture</p>
    </div>

    <form method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 0;">
      {% csrf_token %}

      <!-- Display non-field errors -->
      {% if form.non_field_errors %}
        <div class="non-field-errors" style="margin-bottom: 24px;">
          {% for error in form.non_field_errors %}
            <p style="margin: 0;">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Full Name -->
      <div class="form-group">
        <label for="{{ form.full_name.id_for_label }}" class="form-label">
          Full Name
        </label>
        {{ form.full_name }}
        {% if form.full_name.errors %}
          <p class="form-error">{{ form.full_name.errors|first }}</p>
        {% endif %}
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="{{ form.email.id_for_label }}" class="form-label">
          Email Address
        </label>
        {{ form.email }}
        {% if form.email.errors %}
          <p class="form-error">{{ form.email.errors|first }}</p>
        {% endif %}
        <p class="form-help">We'll never share your email with anyone else.</p>
      </div>

      <!-- Profile Picture -->
      <div class="form-group">
        <label for="{{ form.profile_pic.id_for_label }}" class="form-label">
          Profile Picture
        </label>
        {{ form.profile_pic }}
        {% if form.profile_pic.errors %}
          <p class="form-error">{{ form.profile_pic.errors|first }}</p>
        {% endif %}
        <p class="form-help">Choose a new profile picture (JPG, PNG, or GIF, max 5MB)</p>

        <!-- Image Preview -->
        <div id="image-preview" style="display: none;">
          <p class="preview-label">New Image Preview:</p>
          <img id="preview-image" alt="Preview">
        </div>
      </div>

      <!-- Username (Read-only) -->
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text"
               value="{{ user.username }}"
               disabled>
        <p class="form-help">Username cannot be changed.</p>
      </div>

      <!-- Buttons -->
      <div class="form-actions">
        <button type="submit" class="btn-save">
          üíæ Save Changes
        </button>
        <a href="{% url 'profile' %}" class="btn-cancel">
          ‚úï Cancel
        </a>
      </div>

      <!-- Change Password Link -->
      <div class="form-divider">
        <a href="{% url 'change_password' %}" class="change-password-link">
          üîê Change Password ‚Üí
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  // Image preview functionality
  const fileInput = document.getElementById('{{ form.profile_pic.id_for_label }}');
  const previewContainer = document.getElementById('image-preview');
  const previewImage = document.getElementById('preview-image');

  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];

      if (file) {
        // Check file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file');
          return;
        }

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image must be less than 5MB');
          return;
        }

        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.style.display = 'none';
      }
    });
  }
</script>

{% endblock %}
